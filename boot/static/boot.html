<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    
    <title>BOOT</title>

    <link href="./css/bootstrap.min.css" rel="stylesheet">
    <link href="./css/boot.css" rel="stylesheet">
    
    <script src="./js/jquery.min.js"></script>
    <script src="./js/jquery.cookie.js"></script>
    <script src="./js/bootstrap.min.js"></script>
    <script src="./js/common.js"></script>
  </head>

  <body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container-fluid">
        <div class="navbar-header">
          <a class="navbar-brand" href="boot.html">BOOT</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
            <li><a>FILES</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
    	<br/>
    	<table class="table table-striped" id="table">
    		<thead>
				<tr>
					<th></th>
					<th>名称</th>
					<th>CODE</th>
					<th>GROUP</th>
					<th>当前JAR</th>
					<th>TEST</th>
					<th>UAT</th>
					<th>PRD</th>
					<th>管理</th>
				</tr>
    		</thead>
    		<tbody id="content"></tbody>
    	</table>
    	<br/>
		<button class="btn btn-primary" onclick="reset()">重置 >>>></button>
    	<button class="btn btn-primary" onclick="start()">发布 >>>></button>
    </div>
  </body>

	<script>
		var env = {
			search: null,
			from: 0,
			number: 10
		}

		var xhr;

		function reset() {
			common.req("reset.do", null, r => {
				refresh();
			});
		}

		function refresh() {
			common.req("list.json", env, r => {
				var line = "";
				for (var k in r.list) {
					var v = r.list[k];
					v.state = v.state == null ? "stop" : v.state;
					v.restart = v.restartTime == null ? "" : v.restartTime.format("yyyy-MM-dd hh:mm:ss");
					v.option = '<a onclick="packSvn({id})">打包</a> <a onclick="manage({id})">详情</a>'.format(v);
					line += "<tr align='center'><td><input type='checkbox' id='check{id}'/></td><td>{name}</td><td>{code}</td><td>{group}</td><td id='file{id}'>{jar}</td><td id='test{id}'></td><td id='uat{id}'></td><td id='prd{id}'></td><td>{option}</td></tr>".format(v);
					health(v.id);
				}
				$("#content").html(line);
			});
		}

		function packSvn(serviceId) {
			alert("暂不支持");
		}

		function health(serviceId) {
		    common.req("health.json", {serviceId:serviceId}, r => {
		        $("#test" + serviceId).html(r.test[0] + "/" + r.test[1]);
		        $("#uat" + serviceId).html(r.uat[0] + "/" + r.uat[1]);
		        $("#prd" + serviceId).html(r.prd[0] + "/" + r.prd[1]);
		    });
		}

		function manage(serviceId) {
			document.location.href = "manage.html?serviceId=" + serviceId;
		}

		function onReady() {
			if (xhr.readyState == 4) {
				var rsp = JSON.parse(xhr.responseText);
				for (var id in rsp.content) {
					$("#file" + id).html("<b><font color='#F00'>" + rsp.content[id] + "</font></b>");
					$("#check" + id).attr("checked", "true");
				}
			}
		}

		function start() {
			var serviceId = null;
			$("input").each(function(){
				if ($(this).is(':checked')) {
					var id = $(this).attr("id").substring(5);
					serviceId = serviceId == null ? id  : serviceId + "," + id;
				}
			});
			document.location.href = "manage.html?serviceId=" + serviceId;
		}

		$(function(){ 
			refresh();
		    $(document).on({ 
		        dragleave:function(e){    //拖离 
		            e.preventDefault(); 
		        }, 
		        drop:function(e){  //拖后放 
		            e.preventDefault(); 
		        }, 
		        dragenter:function(e){    //拖进 
		            e.preventDefault(); 
		        }, 
		        dragover:function(e){    //拖来拖去 
		            e.preventDefault(); 
		        } 
		    }); 

	        var box = document.getElementById('table'); //拖拽区域 
	    	box.addEventListener("drop", function(e){ 
		        e.preventDefault();
		        var fileList = e.dataTransfer.files;
		        if(fileList.length == 0)
		            return false; 
		         
		        xhr = new XMLHttpRequest(); 
		        xhr.open("post", common.url("file.do"), true); 
		        xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest"); 
		        xhr.onreadystatechange = onReady;
		         
		        var fd = new FormData(); 
		        for (var i=0;i<fileList.length;i++)
		        	fd.append("file", fileList[i]); 
		        xhr.send(fd); 

		        console.log(xhr.response)
		    }, false); 
		}); 
	</script>
</html>
