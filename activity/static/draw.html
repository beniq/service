<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<meta name="description" content="">
		<meta name="author" content="">

		<title>ACTIVITY</title>

		<link href="./css/bootstrap.min.css" rel="stylesheet">
		<link href="./css/web.css" rel="stylesheet">

		<script src="./js/jquery.min.js"></script>
		<script src="./js/bootstrap.min.js"></script>
		<script src="./js/common.js"></script>

		<script src="./js/react.js"></script>
		<script src="./js/react-dom.js"></script>
		<script src="./js/browser.min.js"></script>
	</head>

	<body>
		<div id="content"></div>

		<script type="text/babel">
			var ENV = {
			    W: 750,
				H: 1200,
				index: 0,
				images: {},
				imagesOnload: {}
            };

            ENV.getImage = function(url) {
                let img = ENV.images[url];
                if (img == null) {
                    img = new Image();
                    img.src = common.server() + "/" + url;
                    img.onload = function() {
                        img.succ = true;
                        let listeners = ENV.imagesOnload[url];
                        listeners.map(l => { l() });
					}
					img.onerror = function() {
					}
                    ENV.imagesOnload[url] = [];
                    ENV.images[url] = img;
                }
                return img;
            }

            ENV.drawImage = function(c, src, x, y, w, h) {
                let img = ENV.getImage(src);
                if (img.complete && img.succ) {
					c.drawImage(img, 0, 0, img.width, img.height, x, y, w, h);
                } else {
                    let ll = ENV.imagesOnload[src];
                    ll.push(function() {
                        c.drawImage(img, 0, 0, img.width, img.height, x, y, w, h);
                    });
                }
            }

            ENV.draw = function() {
                let canvas = document.getElementById("canvas");
                let c = canvas.getContext("2d");
                c.fillStyle = "black";
                c.fillRect(0, 0, ENV.W, ENV.H);
                let page = ENV.doc.pages[ENV.index];
                if (page.background != null)
                    ENV.drawImage(c, page.background, 0, 0, ENV.W, ENV.H);
                page.elements.map(e => {
                    if (e.bgColor != null && e.bgColor != "") {
                        c.fillStyle = "#" + e.bgColor;
                        c.fillRect(e.x, e.y, e.w, e.h);
                    }
                    if (e.image != null && e.image != "") {
                        ENV.drawImage(c, e.image, e.x, e.y, e.w, e.h);
                    }
                })
                if (ENV.selected) {
                    c.fillStyle = "rgba(100%,60%,60%,0.5)";
                    c.fillRect(ENV.selected.x, ENV.selected.y, ENV.selected.w, ENV.selected.h);
                }
                if (ENV.cursorRect) {
                    c.fillStyle = "rgba(100%,60%,60%,0.5)";
                    c.fillRect(ENV.cursorRect.x, ENV.cursorRect.y, ENV.cursorRect.w, ENV.cursorRect.h);
                }
            }

            var Main = React.createClass({
                getInitialState() {
                    return {w:90, h:160};
                },
                componentDidMount() {
					if (ENV.actId == null || ENV.actId == "") {
						common.req("new_act.json", {}, r => this.refresh(r));
					} else {
						common.req("view_act.json", {actId:ENV.actId}, r => this.refresh(r));
					}

                    let drop = e => {
                        e.preventDefault();
                        var fileList = e.dataTransfer.files;
                        if(fileList.length == 0)
                            return false;

                        var xhr = new XMLHttpRequest();
                        xhr.open("post", common.url("file.do"), true);
                        xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
                        xhr.onreadystatechange = r => {
                            if (xhr.readyState == 4 && xhr.status == 200) {
                                this.refresh(JSON.parse(xhr.responseText).content);
                            }
                        };

                        var fd = new FormData();
                        fd.append("pageIndex", 0);
                        fd.append("actId", ENV.doc.actId);
                        if (e.target == document.getElementById('pBg')) {
                            fd.append("type", "desk");
                        } else if (e.target == document.getElementById('eImage')) {
                            fd.append("elementIndex", ENV.select.index);
                            fd.append("type", "image");
                        } else if (e.target == document.getElementById('canvas')) {
                            fd.append("type", "element");
                        } else {
                            fd = null;
						}
						if (fd != null) {
                            for (var i = 0; i < fileList.length; i++)
                                fd.append("file", fileList[i]);
                            xhr.send(fd);
                        }
                    };

                    document.getElementById('desk').addEventListener("drop", drop, false);
                    document.getElementById('detail').addEventListener("drop", drop, false);
                },
                refresh(doc) {
                    if (doc != null) ENV.doc = doc;
                    let page = ENV.doc.pages[ENV.index];
                    ENV.W = page.w;
                    ENV.H = page.h;
                    let w = document.getElementById('desk').clientWidth;
                    this.setState({w: w, h: ENV.H * w / ENV.W}, () => {
                        ENV.draw();
                    })
                },
				clickSelect(e) {
                    let c = $("#canvas");
                    let s = c.offset();
					let x = (e.clientX - s.left) * ENV.W / c.width();
                    let y = (e.clientY - s.top) * ENV.H / c.height();
                    let page = ENV.doc.pages[ENV.index];
                    page.elements.map((e, i) => {
                        if (e.x <= x && e.y <= y && e.x + e.w >= x && e.y + e.h >= y)
                            ENV.selected = e;
                    });
                    this.refresh();
				},
                select(e) {
                    ENV.selected = e;
                    this.refresh();
                },
				drag(e) {
                    let f = ENV.selected;
                    if (f == null)
                        f = {};
                    let c = $("#canvas");
                    let s = c.offset();
                    let x = (e.clientX - s.left) * ENV.W / c.width();
                    let y = (e.clientY - s.top) * ENV.H / c.height();
                    if (e.type == "dragstart") {
						ENV.drag = {sx:x, sy:y, ex:f.x, ey:f.y, ew:f.w, eh:f.h};
                        ENV.cursorRect = null;
						if (e.altKey || e.ctrlKey) {
                            ENV.drag.mode = 10;
						} else if (f.x <= x && f.y <= y && f.x + f.w >= x && f.y + f.h >= y) {
                            ENV.drag.mode = 5;
                        } else if (f.x <= x && f.y > y && f.x + f.w >= x && f.y - 20 < y) {
                            ENV.drag.mode = 8;
						}
					} else if (ENV.drag.mode != null) {
                        if (e.type == "drag") {
                            if (ENV.drag.mode == 10) {
                                ENV.cursorRect = {x:ENV.drag.sx, y:ENV.drag.sy, z:1, w:x - ENV.drag.sx, h:y - ENV.drag.sy};
                            } else if (ENV.drag.mode == 5) {
                                ENV.selected.x = ENV.drag.ex + x - ENV.drag.sx;
                                ENV.selected.y = ENV.drag.ey + y - ENV.drag.sy;
                            } else if (ENV.drag.mode == 3) {
                                ENV.selected.w = ENV.drag.ew + x - ENV.drag.sx;
                                ENV.selected.h = ENV.drag.eh + y - ENV.drag.sy;
                            } else if (ENV.drag.mode == 8) {
                                ENV.selected.y = ENV.drag.ey + y - ENV.drag.sy;
                                ENV.selected.h = ENV.drag.eh + ENV.drag.sy - y;
                            }
                            ENV.draw();
						} else if (e.type == "dragend") {
                            if (ENV.drag.mode == 10) {
                                ENV.selected = ENV.cursorRect;
                                ENV.cursorRect = null;
                            } else {
                                ENV.selected.x = Math.round((ENV.selected.x * 100) / 100);
                                ENV.selected.y = Math.round((ENV.selected.y * 100) / 100);
                                ENV.selected.w = Math.round((ENV.selected.w * 100) / 100);
                                ENV.selected.h = Math.round((ENV.selected.h * 100) / 100);
                            }
                            this.saveElement();
                        }
                    }
				},
                saveElement() {
                    common.req("element.json", {
                        actId: ENV.actId,
                        pageIndex: ENV.index,
						element: ENV.selected
                    }, r => {
                        this.refresh(r);
                    });
                },
                element() {

				},
				delete(i) {
					if (confirm("删除？")) {
                        common.req("del_element.json", {
                            actId: ENV.actId,
                            pageIndex: ENV.index,
                            index: i
                        }, r => {
                            this.refresh(r);
                        });
					}
				},
				fillBgColor(e) { //以element的四个角的颜色平均值填充背景色
                    let img = ENV.getImage(ENV.doc.pages[ENV.index].background);
                    let canvas = document.getElementById("canvas");
                    let c = canvas.getContext("2d");

                    let x1 = e.x - 1;
                    let y1 = e.y - 1;
                    let x2 = e.x + e.w + 1;
                    let y2 = e.y + e.h + 1;

                    let rgb = [0, 0, 0, 0];
                    if (x1 >= 0 && y1 >= 0 && x1 < ENV.W && y1 < ENV.H) {
                        let d1 = c.getImageData(x1, y1, 1, 1).data;
                        rgb[0] += d1[0];
                        rgb[1] += d1[1];
                        rgb[2] += d1[2];
                        rgb[3]++;
                    }
                    if (x1 >= 0 && y2 >= 0 && x1 < ENV.W && y2 < ENV.H) {
                        let d1 = c.getImageData(x1, y2, 1, 1).data;
                        rgb[0] += d1[0];
                        rgb[1] += d1[1];
                        rgb[2] += d1[2];
                        rgb[3]++;
                    }
                    if (x2 >= 0 && y1 >= 0 && x2 < ENV.W && y1 < ENV.H) {
                        let d1 = c.getImageData(x2, y1, 1, 1).data;
                        rgb[0] += d1[0];
                        rgb[1] += d1[1];
                        rgb[2] += d1[2];
                        rgb[3]++;
                    }
                    if (x2 >= 0 && y2 >= 0 && x2 < ENV.W && y2 < ENV.H) {
                        let d1 = c.getImageData(x2, y2, 1, 1).data;
                        rgb[0] += d1[0];
                        rgb[1] += d1[1];
                        rgb[2] += d1[2];
                        rgb[3]++;
                    }
                    if (rgb[3] > 0) {
                        e.bgColor = Math.round(rgb[0] / rgb[3]).toString(16) + Math.round(rgb[1] / rgb[3]).toString(16) + Math.round(rgb[2] / rgb[3]).toString(16);
					}
                    this.saveElement();
                },
                setZIndex(e, k) {
                    if (k == 0) {
                        e.z = 0;
					} else {
                        e.z += k;
                    }
                    this.saveElement();
                },
                deploy(env) {
                    common.req("deploy.json", {actId: ENV.actId, env:env}, r => { alert(r) });
				},
                render() {
                    let tree = ENV.doc == null ? null : ENV.doc.pages.map((page, i) => {
                        return (
                            <div className="ml-3">
                                <div className={"pl-2 pr-2 pt-1 pb-1 " + (ENV.selected == null && i == ENV.index ? "text-white bg-danger" : "")} onClick={this.select.bind(this, null, null)}>第{i+1}页</div>
                                { page.elements.map((e, j) => {
                                    return (
                                        <div className={"form-row ml-3 pl-2 pr-2 pt-1 pb-1 " + (e == ENV.selected ? "text-white bg-danger" : "")} onClick={this.select.bind(this, e, j)}>
											<div className="mr-auto">元素 [{e.x},{e.y}] [{e.w},{e.h}]{e.image != null ? " [图片]" : null}</div>
											<div onClick={this.delete.bind(this, j)}>&nbsp;X&nbsp;</div>
										</div>
									);
                                })}
                            </div>
                        )
                    });
                    let detail;
                    if (ENV.selected == null) {
                        let p = ENV.doc == null ? {} : ENV.doc.pages[ENV.index];
                        detail = <div key={"page" + ENV.index}>
							<div className="input-group pl-2 pr-2 pt-1 pb-1">
								<div className="input-group-prepend">
									<div className="btn btn-primary" style={{width:"100px"}}>宽</div>
								</div>
								<input type="text" className="form-control" ref="pW" defaultValue={p.w} onChange={v => {p.w = v.target.value}}/>
							</div>
							<div className="input-group pl-2 pr-2 pt-1 pb-1">
								<div className="input-group-prepend">
									<div className="btn btn-primary" style={{width:"100px"}}>高</div>
								</div>
								<input type="text" className="form-control" ref="pH" defaultValue={p.h} onChange={v => {p.h = v.target.value}}/>
							</div>
							<div className="input-group pl-2 pr-2 pt-1 pb-1">
								<div className="input-group-prepend">
									<div className="btn btn-primary" style={{width:"100px"}}>背景</div>
								</div>
								<input type="text" className="form-control" id="pBg" ref="pBg" value={p.background}/>
							</div>
						</div>
                    } else {
                        let e = ENV.selected;
                        detail = <div key={"element" + e.index}>
							<div className="input-group pl-2 pr-2 pt-1 pb-1">
								<div className="input-group-prepend">
									<div className="btn btn-primary" style={{width:"100px"}}>X</div>
								</div>
								<input type="text" className="form-control" ref="eX" defaultValue={e.x} onChange={v => {e.x = v.target.value}} onBlur={this.saveElement}/>
							</div>
							<div className="input-group pl-2 pr-2 pt-1 pb-1">
								<div className="input-group-prepend">
									<div className="btn btn-primary" style={{width:"100px"}}>Y</div>
								</div>
								<input type="text" className="form-control" ref="eY" defaultValue={e.y} onChange={v => {e.y = v.target.value}} onBlur={this.saveElement}/>
							</div>
							<div className="input-group pl-2 pr-2 pt-1 pb-1">
								<div className="input-group-prepend">
									<div className="btn btn-primary" style={{width:"100px"}}>Z</div>
									<div className="btn btn-outline-dark" onClick={this.setZIndex.bind(this, e, -1)}>▼</div>
								</div>
								<input type="text" className="form-control text-center" ref="eZ" value={e.z} readOnly="true"/>
								<div className="input-group-append">
									<div className="btn btn-outline-dark" onClick={this.setZIndex.bind(this, e, 1)}>▲</div>
									<div className="btn btn-outline-dark" onClick={this.setZIndex.bind(this, e, 0)}>RESET</div>
								</div>
							</div>
							<div className="input-group pl-2 pr-2 pt-1 pb-1">
								<div className="input-group-prepend">
									<div className="btn btn-primary" style={{width:"100px"}}>宽</div>
								</div>
								<input type="text" className="form-control" ref="eW" defaultValue={e.w} onChange={v => {e.w = v.target.value}} onBlur={this.saveElement}/>
							</div>
							<div className="input-group pl-2 pr-2 pt-1 pb-1">
								<div className="input-group-prepend">
									<div className="btn btn-primary" style={{width:"100px"}}>高</div>
								</div>
								<input type="text" className="form-control" ref="eH" defaultValue={e.h} onChange={v => {e.h = v.target.value}} onBlur={this.saveElement}/>
							</div>
							<div className="input-group pl-2 pr-2 pt-1 pb-1">
								<div className="input-group-prepend">
									<div className="btn btn-primary" style={{width:"100px"}}>纵横比</div>
								</div>
								<select className="form-control" ref="eKeep">
									<option value="Y">自由</option>
									<option value="N">按图片锁定</option>
								</select>
							</div>
							<div className="input-group pl-2 pr-2 pt-1 pb-1">
								<div className="input-group-prepend">
									<div className="btn btn-primary" style={{width:"100px"}}>背景色</div>
								</div>
								<input type="text" className="form-control" id="eBgColor" ref="eBgColor" defaultValue={e.bgColor} onChange={v => {e.bgColor = v.target.value}}/>
								<div className="input-group-append">
									<div className="btn btn-success" onClick={this.fillBgColor.bind(this, e)}>同色填充</div>
								</div>
							</div>
							<div className="input-group pl-2 pr-2 pt-1 pb-1">
								<div className="input-group-prepend">
									<div className="btn btn-primary" style={{width:"100px"}}>背景</div>
								</div>
								<input type="text" className="form-control" id="eImage" ref="eImage" value={e.image}/>
							</div>
							<div className="input-group pl-2 pr-2 pt-1 pb-1">
								<div className="input-group-prepend">
									<div className="btn btn-primary" style={{width:"100px"}}>事件类型</div>
								</div>
								<select className="form-control" ref="eAction" defaultValue={e.action} onChange={v => {e.action = v.target.value}} onBlur={this.saveElement}>
									<option value="">无</option>
									<option value="1">跳转</option>
									<option value="2">JS方法</option>
									<option value="3">跳转产品</option>
									<option value="4">转发产品</option>
								</select>
							</div>
							<div className="input-group pl-2 pr-2 pt-1 pb-1">
								<div className="input-group-prepend">
									<div className="btn btn-primary" style={{width:"100px"}}>事件参数</div>
								</div>
								<input type="text" className="form-control" ref="eParam" defaultValue={e.param} onChange={v => {e.param = v.target.value}}  onBlur={this.saveElement}/>
							</div>
						</div>
					}
                    return (
						<div className="form-horizontal">
							<div className="form-row m-0 p-0">
								<div className="col-sm-4 m-0 p-0" id="desk" style={{overflowY:"scroll", overflowX:"hidden", height:window.innerHeight+"px"}}>
									<canvas id="canvas" ref="canvas" style={{width:this.state.w + "px", height:this.state.h + "px"}} width={ENV.W} height={ENV.H} onClick={this.clickSelect} draggable="true" onDragStart={this.drag} onDrag={this.drag} onDragEnd={this.drag}></canvas>
								</div>
								<div className="col-sm-8 m-0">
									<div className="navbar navbar-expand-lg navbar-light bg-light m-0">
										<div className="mr-auto">
											<button type="button" className="btn btn-success mr-2" onClick={ENV.draw}>刷新</button>
											<button type="button" className="btn btn-success mr-2">页面</button>
											<button type="button" className="btn btn-success mr-2" onClick={this.element.bind(this, 0)}>元素</button>
										</div>
										<div className="text-right">
											<button type="button" className="btn btn-danger mr-2" onClick={this.deploy.bind(this, "test")}>发布测试</button>
											<button type="button" className="btn btn-danger mr-2">发布预发</button>
											<button type="button" className="btn btn-danger mr-2">发布生产</button>
										</div>
									</div>
									<div className="form-row m-0">
										<div className="col-sm-6 pt-3 pl-3 pr-3 pb-3">
											<div className="pl-2 pr-2 pt-1 pb-1">活动文档</div>
											{tree}
										</div>
										<div className="col-sm-6 pt-3 pl-3 pr-3 pb-3" id="detail">
											{detail}
										</div>
									</div>
								</div>
							</div>
						</div>
                    );
                }
            });

            $(document).ready( function() {
                ENV.actId = common.param("actId");
                ReactDOM.render(<Main/>, document.getElementById("content"));

                $(document).on({
                    dragleave:function(e){    //拖离
                        e.preventDefault();
                    },
                    drop:function(e){  //拖后放
                        e.preventDefault();
                    },
                    dragenter:function(e){    //拖进
                        e.preventDefault();
                    },
                    dragover:function(e){    //拖来拖去
                        e.preventDefault();
                    }
                });
            });
		</script>
	</body>
</html>